<div class="mb-3 highlight-addon field-crelishdynamicmodel-{{ formKey }} widget-connector" id="{{ fieldId }}_container">
    <label class="form-label" for="{{ fieldId }}_widget">
        {{ field.label|default('Widget') }}
    </label>

    {# Hidden input for widgetType (the widget class name) - uses the field key from element definition #}
    <input type="hidden"
           name="CrelishDynamicModel[{{ field.key }}]"
           id="{{ fieldId }}_widgetType"
           value="{{ selectedWidget|default('')|e('html_attr') }}"/>

    {# Hidden input for options (JSON string) - always 'options' as per element definition #}
    <input type="hidden"
           name="CrelishDynamicModel[options]"
           id="{{ fieldId }}_options"
           value="{{ currentOptions|json_encode|e('html_attr') }}"/>

    {# Widget Selection Dropdown #}
    <div class="mb-3">
        <select class="form-select" id="{{ fieldId }}_widget">
            <option value="">{{ t('app', '-- Widget auswählen --') }}</option>
            {% set currentCategory = '' %}
            {% for name, widget in availableWidgets %}
                {% set category = widget.meta.category|default('other') %}
                {% if category != currentCategory %}
                    {% if currentCategory != '' %}
                        </optgroup>
                    {% endif %}
                    <optgroup label="{{ category|capitalize }}">
                    {% set currentCategory = category %}
                {% endif %}
                <option value="{{ name }}"
                        data-configurable="{{ widget.configurable ? 'true' : 'false' }}"
                        data-schema="{{ widget.schema|json_encode|e('html_attr') }}"
                        {% if selectedWidget == name %}selected{% endif %}>
                    {{ widget.meta.label }}
                    {% if not widget.configurable %}(Legacy){% endif %}
                </option>
            {% endfor %}
            {% if currentCategory != '' %}
                </optgroup>
            {% endif %}
        </select>
        <div id="{{ fieldId }}_description" class="form-text text-muted">
            {% if selectedWidget and availableWidgets[selectedWidget] %}
                {{ availableWidgets[selectedWidget].meta.description|default('') }}
            {% endif %}
        </div>
    </div>

    {# Dynamic Configuration Fields Container #}
    <div id="{{ fieldId }}_config" class="widget-config-fields">
        {# Fields will be rendered here by JavaScript based on selected widget's schema #}
    </div>

    {# Legacy JSON input for non-configurable widgets #}
    <div id="{{ fieldId }}_legacy" class="widget-legacy-config" style="display: none;">
        <label class="form-label">{{ t('app', 'Widget Optionen (JSON)') }}</label>
        <textarea class="form-control font-monospace" id="{{ fieldId }}_legacy_json" rows="4" placeholder='{"key": "value"}'></textarea>
        <small class="form-text text-muted">{{ t('app', 'Dieses Widget unterstützt keine automatische Konfiguration. Bitte JSON manuell eingeben.') }}</small>
    </div>
</div>

<style>
.widget-connector .widget-config-fields {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    background: #f8f9fa;
    margin-top: 0.5rem;
}

.widget-connector .widget-config-fields:empty {
    display: none;
}

.widget-connector .widget-config-fields .config-field {
    margin-bottom: 1rem;
}

.widget-connector .widget-config-fields .config-field:last-child {
    margin-bottom: 0;
}

.widget-connector .widget-config-fields .config-field label {
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.widget-connector .widget-config-fields .config-field .form-text {
    font-size: 0.8rem;
    color: #6c757d;
}

.widget-connector .widget-legacy-config {
    margin-top: 1rem;
}

.widget-connector .widget-legacy-config textarea {
    font-size: 0.875rem;
}

/* Dark mode support */
html[data-theme="dark"] .widget-connector .widget-config-fields {
    border-color: #495057;
    background: #1e2a3b;
}

html[data-theme="dark"] .widget-connector .widget-config-fields .config-field .form-text {
    color: #adb5bd;
}
</style>

<script>
(function($) {
    $(document).ready(function() {
        var container = $('#{{ fieldId }}_container');
        var widgetSelect = $('#{{ fieldId }}_widget');
        var widgetTypeInput = $('#{{ fieldId }}_widgetType');
        var optionsInput = $('#{{ fieldId }}_options');
        var configContainer = $('#{{ fieldId }}_config');
        var legacyContainer = $('#{{ fieldId }}_legacy');
        var legacyTextarea = $('#{{ fieldId }}_legacy_json');
        var descriptionDiv = $('#{{ fieldId }}_description');

        // Widget metadata for descriptions
        var widgetMeta = {{ availableWidgets|json_encode|raw }};

        // Current options state
        var currentOptions = {{ currentOptions|json_encode|raw }};

        // Field type renderers
        var fieldRenderers = {
            'text': function(key, config, value) {
                return '<div class="config-field">' +
                    '<label for="{{ fieldId }}_opt_' + key + '">' + config.label + (config.required ? ' *' : '') + '</label>' +
                    '<input type="text" class="form-control" ' +
                    'id="{{ fieldId }}_opt_' + key + '" ' +
                    'data-key="' + key + '" ' +
                    'value="' + escapeHtml(value || config.default || '') + '" ' +
                    (config.placeholder ? 'placeholder="' + escapeHtml(config.placeholder) + '"' : '') +
                    (config.required ? 'required' : '') + '>' +
                    (config.hint ? '<small class="form-text">' + config.hint + '</small>' : '') +
                    '</div>';
            },

            'textarea': function(key, config, value) {
                return '<div class="config-field">' +
                    '<label for="{{ fieldId }}_opt_' + key + '">' + config.label + (config.required ? ' *' : '') + '</label>' +
                    '<textarea class="form-control" ' +
                    'id="{{ fieldId }}_opt_' + key + '" ' +
                    'data-key="' + key + '" ' +
                    'rows="3" ' +
                    (config.placeholder ? 'placeholder="' + escapeHtml(config.placeholder) + '"' : '') +
                    (config.required ? 'required' : '') + '>' +
                    escapeHtml(value || config.default || '') +
                    '</textarea>' +
                    (config.hint ? '<small class="form-text">' + config.hint + '</small>' : '') +
                    '</div>';
            },

            'number': function(key, config, value) {
                var val = value !== undefined && value !== null ? value : (config.default !== undefined ? config.default : '');
                return '<div class="config-field">' +
                    '<label for="{{ fieldId }}_opt_' + key + '">' + config.label + (config.required ? ' *' : '') + '</label>' +
                    '<input type="number" class="form-control" ' +
                    'id="{{ fieldId }}_opt_' + key + '" ' +
                    'data-key="' + key + '" ' +
                    'value="' + val + '" ' +
                    (config.min !== undefined ? 'min="' + config.min + '"' : '') +
                    (config.max !== undefined ? 'max="' + config.max + '"' : '') +
                    (config.step !== undefined ? 'step="' + config.step + '"' : '') +
                    (config.required ? 'required' : '') + '>' +
                    (config.hint ? '<small class="form-text">' + config.hint + '</small>' : '') +
                    '</div>';
            },

            'select': function(key, config, value) {
                var currentVal = value !== undefined && value !== null ? value : (config.default || '');
                var html = '<div class="config-field">' +
                    '<label for="{{ fieldId }}_opt_' + key + '">' + config.label + (config.required ? ' *' : '') + '</label>' +
                    '<select class="form-select" id="{{ fieldId }}_opt_' + key + '" data-key="' + key + '"' +
                    (config.required ? ' required' : '') + '>';

                if (!config.required) {
                    html += '<option value="">-- {{ t('app', 'Auswählen') }} --</option>';
                }

                for (var optKey in config.options) {
                    var selected = (optKey == currentVal) ? ' selected' : '';
                    html += '<option value="' + escapeHtml(optKey) + '"' + selected + '>' +
                        escapeHtml(config.options[optKey]) + '</option>';
                }

                html += '</select>' +
                    (config.hint ? '<small class="form-text">' + config.hint + '</small>' : '') +
                    '</div>';
                return html;
            },

            'checkbox': function(key, config, value) {
                var checked = value !== undefined && value !== null ? value : (config.default || false);
                return '<div class="config-field">' +
                    '<div class="form-check">' +
                    '<input type="checkbox" class="form-check-input" ' +
                    'id="{{ fieldId }}_opt_' + key + '" ' +
                    'data-key="' + key + '" ' +
                    (checked ? 'checked' : '') + '>' +
                    '<label class="form-check-label" for="{{ fieldId }}_opt_' + key + '">' +
                    config.label + '</label>' +
                    '</div>' +
                    (config.hint ? '<small class="form-text">' + config.hint + '</small>' : '') +
                    '</div>';
            },

            'radio': function(key, config, value) {
                var currentVal = value !== undefined && value !== null ? value : (config.default || '');
                var html = '<div class="config-field">' +
                    '<label>' + config.label + (config.required ? ' *' : '') + '</label>';

                for (var optKey in config.options) {
                    var checked = (optKey == currentVal) ? ' checked' : '';
                    var radioId = '{{ fieldId }}_opt_' + key + '_' + optKey;
                    html += '<div class="form-check">' +
                        '<input type="radio" class="form-check-input" ' +
                        'name="{{ fieldId }}_opt_' + key + '" ' +
                        'id="' + radioId + '" ' +
                        'data-key="' + key + '" ' +
                        'value="' + escapeHtml(optKey) + '"' + checked + '>' +
                        '<label class="form-check-label" for="' + radioId + '">' +
                        escapeHtml(config.options[optKey]) + '</label>' +
                        '</div>';
                }

                html += (config.hint ? '<small class="form-text">' + config.hint + '</small>' : '') +
                    '</div>';
                return html;
            },

            'color': function(key, config, value) {
                return '<div class="config-field">' +
                    '<label for="{{ fieldId }}_opt_' + key + '">' + config.label + (config.required ? ' *' : '') + '</label>' +
                    '<input type="color" class="form-control form-control-color" ' +
                    'id="{{ fieldId }}_opt_' + key + '" ' +
                    'data-key="' + key + '" ' +
                    'value="' + (value || config.default || '#000000') + '">' +
                    (config.hint ? '<small class="form-text">' + config.hint + '</small>' : '') +
                    '</div>';
            },

            'relation': function(key, config, value) {
                var ctype = config.ctype || 'page';
                var displayField = config.displayField || 'systitle';
                var selectId = '{{ fieldId }}_opt_' + key;

                var html = '<div class="config-field config-field--relation">' +
                    '<label for="' + selectId + '">' + config.label + (config.required ? ' *' : '') + '</label>' +
                    '<select class="form-select relation-select" ' +
                    'id="' + selectId + '" ' +
                    'data-key="' + key + '" ' +
                    'data-ctype="' + ctype + '" ' +
                    'data-display-field="' + displayField + '" ' +
                    (config.required ? 'required' : '') + '>' +
                    '<option value="">{{ t('app', '-- Bitte wählen --') }}</option>';

                // If we have a current value, add it as a selected option (will be populated by AJAX)
                if (value) {
                    html += '<option value="' + escapeHtml(value) + '" selected data-loading="true">{{ t('app', 'Laden...') }}</option>';
                }

                html += '</select>' +
                    (config.hint ? '<small class="form-text">' + config.hint + '</small>' : '') +
                    '</div>';

                return html;
            }
        };

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(String(text)));
            return div.innerHTML;
        }

        function renderConfigFields(schema) {
            configContainer.empty();

            if (!schema || Object.keys(schema).length === 0) {
                return;
            }

            for (var key in schema) {
                var fieldConfig = schema[key];
                var fieldType = fieldConfig.type || 'text';
                var renderer = fieldRenderers[fieldType] || fieldRenderers['text'];
                var currentValue = currentOptions[key];

                // Check dependencies
                if (fieldConfig.dependsOn) {
                    var show = true;
                    for (var depKey in fieldConfig.dependsOn) {
                        var depValue = fieldConfig.dependsOn[depKey];
                        var actualValue = currentOptions[depKey];
                        if (Array.isArray(depValue)) {
                            if (depValue.indexOf(actualValue) === -1) {
                                show = false;
                                break;
                            }
                        } else if (actualValue != depValue) {
                            show = false;
                            break;
                        }
                    }
                    if (!show) continue;
                }

                configContainer.append(renderer(key, fieldConfig, currentValue));
            }

            // Bind change events
            configContainer.find('input, select, textarea').on('change input', function() {
                updateOptions();
            });

            // Initialize Select2 for relation fields
            initRelationSelects();
        }

        function initRelationSelects() {
            configContainer.find('.relation-select').each(function() {
                var $select = $(this);
                var ctype = $select.data('ctype');
                var displayField = $select.data('display-field') || 'systitle';
                var currentValue = $select.val();

                // Function to initialize Select2
                function initSelect2() {
                    $select.select2({
                        theme: 'krajee-bs5',
                        width: '100%',
                        allowClear: true,
                        placeholder: '{{ t('app', '-- Bitte wählen --') }}',
                        ajax: {
                            url: '/crelish-api/content/' + ctype,
                            dataType: 'json',
                            delay: 300,
                            data: function(params) {
                                return {
                                    filter: params.term ? displayField + ':' + params.term : '',
                                    page: params.page || 1
                                };
                            },
                            processResults: function(data, params) {
                                params.page = params.page || 1;
                                var results = [];
                                if (data.success && data.data && data.data.items) {
                                    results = data.data.items.map(function(item) {
                                        return {
                                            id: item.uuid,
                                            text: item[displayField] || item.systitle || item.title || item.uuid
                                        };
                                    });
                                }
                                return {
                                    results: results,
                                    pagination: {
                                        more: (params.page * 20) < (data.data ? data.data.total || 0 : 0)
                                    }
                                };
                            },
                            cache: true
                        }
                    });

                    // Bind change event to update options
                    $select.on('change', function() {
                        updateOptions();
                    });
                }

                // If we have a current value, load the display text first, then init Select2
                if (currentValue) {
                    $.ajax({
                        url: '/crelish-api/content/' + ctype,
                        data: { filter: 'uuid:' + currentValue },
                        dataType: 'json'
                    }).then(function(data) {
                        if (data.success && data.data && data.data.items && data.data.items.length > 0) {
                            var item = data.data.items[0];
                            var text = item[displayField] || item.systitle || item.title || item.uuid;
                            // Update the option text before initializing Select2
                            $select.find('option[value="' + currentValue + '"]').text(text).removeAttr('data-loading');
                        }
                        initSelect2();
                    }).fail(function() {
                        // Initialize anyway on failure
                        initSelect2();
                    });
                } else {
                    initSelect2();
                }
            });
        }

        function updateOptions() {
            var selectedWidget = widgetSelect.val();
            var option = widgetSelect.find('option:selected');
            var isConfigurable = option.data('configurable') === true || option.data('configurable') === 'true';

            var options = {};

            if (isConfigurable) {
                // Gather values from config fields
                configContainer.find('[data-key]').each(function() {
                    var $el = $(this);
                    var key = $el.data('key');
                    var value;

                    if ($el.is(':checkbox')) {
                        value = $el.is(':checked');
                    } else if ($el.is(':radio')) {
                        if ($el.is(':checked')) {
                            value = $el.val();
                        } else {
                            return; // Skip unchecked radios
                        }
                    } else if ($el.attr('type') === 'number') {
                        value = $el.val() !== '' ? parseFloat($el.val()) : null;
                    } else {
                        value = $el.val();
                    }

                    if (value !== null && value !== '') {
                        options[key] = value;
                    }
                });
            } else {
                // Use legacy JSON
                try {
                    var legacyJson = legacyTextarea.val().trim();
                    if (legacyJson) {
                        options = JSON.parse(legacyJson);
                    }
                } catch (e) {
                    console.warn('Invalid JSON in legacy config');
                }
            }

            // Update the hidden options input
            optionsInput.val(JSON.stringify(options));
            currentOptions = options;
        }

        function onWidgetChange() {
            var selectedWidget = widgetSelect.val();

            // Update the hidden widgetType input
            widgetTypeInput.val(selectedWidget);

            if (!selectedWidget) {
                configContainer.empty();
                legacyContainer.hide();
                optionsInput.val('{}');
                descriptionDiv.text('');
                return;
            }

            var option = widgetSelect.find('option:selected');
            var isConfigurable = option.data('configurable') === true || option.data('configurable') === 'true';
            var schema = option.data('schema');

            // Update description
            if (widgetMeta[selectedWidget] && widgetMeta[selectedWidget].meta) {
                descriptionDiv.text(widgetMeta[selectedWidget].meta.description || '');
            } else {
                descriptionDiv.text('');
            }

            // Reset options when widget changes (unless it's the initial load)
            if (widgetTypeInput.data('initialized')) {
                currentOptions = {};
            }
            widgetTypeInput.data('initialized', true);

            if (isConfigurable && schema) {
                legacyContainer.hide();
                renderConfigFields(schema);
            } else {
                configContainer.empty();
                legacyContainer.show();
                // Populate legacy textarea with current options
                if (Object.keys(currentOptions).length > 0) {
                    legacyTextarea.val(JSON.stringify(currentOptions, null, 2));
                }
            }

            updateOptions();
        }

        // Event handlers
        widgetSelect.on('change', onWidgetChange);
        legacyTextarea.on('change input', updateOptions);

        // Initialize - but don't reset options on initial load
        if (widgetSelect.val()) {
            var option = widgetSelect.find('option:selected');
            var isConfigurable = option.data('configurable') === true || option.data('configurable') === 'true';
            var schema = option.data('schema');

            if (widgetMeta[widgetSelect.val()] && widgetMeta[widgetSelect.val()].meta) {
                descriptionDiv.text(widgetMeta[widgetSelect.val()].meta.description || '');
            }

            if (isConfigurable && schema) {
                legacyContainer.hide();
                renderConfigFields(schema);
            } else {
                configContainer.empty();
                legacyContainer.show();
                if (Object.keys(currentOptions).length > 0) {
                    legacyTextarea.val(JSON.stringify(currentOptions, null, 2));
                }
            }

            widgetTypeInput.data('initialized', true);
        }
    });
})(jQuery);
</script>